---

- name: Creating working directory
  file: 
    path: "{{ ee_path }}"
    state: directory

- name: Copy config files to the working directory
  copy:
    src: "{{ item }}"
    dest: "{{ ee_path }}/{{ item }}"
  with_items:
    - ansible.cfg
    - execution-environment.yml
    - requirements.yml
    - requirements.txt
    - bindep.txt
  become: yes
  
# - name: Install ansible-builder
#   pip:
#     name: ansible-builder
#     state: present
  #become: yes

# - name: Install python-dnf
#   pip:
#     name: python-dnf
#     state: present

# - name: Install podman
#   dnf:
#     name: podman
#     state: present
#   vars:
#     #ansible_python_interpreter: /usr/libexec/platform-python
#     ansible_python_interpreter: /usr/bin/python3

- name: Run ansible-builder command
  command:
    cmd: "{{ ansible_builder_cmd }}"
    chdir: "{{ ee_path }}"
  become: yes

- name: Include vault quay.io credentials
  include_vars: ../vaults/vault_quay.yml

- name: Login into quay.io registry
  containers.podman.podman_login:
    username: "{{ ee_registry_user }}"
    password: "{{ ee_registry_pass }}"
    registry: quay.io

- name: Push EE to quay.io registry
  containers.podman.podman_image:
    name: ee-ansible-ssa
    push: true
    push_args:
      dest: "{{ ee_registry_url }}"

# - name: Push image to image registry
#   command: 
#     cmd: "{{ ee_registry_cmd }}"
#     chdir: "{{ ee_path }}"
#   vars:  
#     registry_quay_username: "{{ ee_registry_user }}"
#     registry_quay_password: "{{ ee_registry_pass }}"
#   become: yes
